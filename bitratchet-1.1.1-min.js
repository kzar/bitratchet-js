/*global module, ArrayBuffer, Uint8Array*//*jslint unparam : true, bitwise: true, regexp: true, indent: 4*/var bitratchet;bitratchet||(bitratchet={}),function(){"use strict",typeof bitratchet.version!="object"&&(bitratchet.version={major:1,patch:1,minor:1,toString:function(){return this.major+"."+this.minor+"."+this.patch}}),typeof bitratchet.record!="function"&&(bitratchet.record=function(b){function c(a){var c;for(c in b)b.hasOwnProperty(c)&&a(c,b[c])}function d(a,b,c){var d,e,f,g=new Uint8Array(a),h=b%8,i;if(c===0){g=g.subarray(b/8),d=new ArrayBuffer(g.length),e=new Uint8Array(d),e[0]=g[0]<<h&255;for(f=1;f<g.length;f+=1)e[f-1]=e[f-1]|g[f]>>8-h,e[f]=g[f]<<h&255}else{i=c%8,g=g.subarray(b/8,b/8+Math.ceil((c+i+h)/8)),d=new ArrayBuffer(Math.ceil(c/8)),e=new Uint8Array(d);if(i){e[0]=g[0]>>8-i-h&Math.pow(2,i)-1;for(f=1;f<e.length;f+=1)e[f]=g[f-1]<<i+h&255|g[f]>>8-h-i}else if(h)for(f=0;f<e.length;f+=1)e[f]=g[f]<<i+h&255|g[f+1]>>8-h-i;else for(f=0;f<e.length;f+=1)e[f]=g[f]}return d}function e(a,b){function j(a,b){b===undefined&&(b=8),a&=Math.pow(2,b)-1,i+b<=8?(g[h]=g[h]|a<<8-i-b,i+=b):(e=b+i-8,g[h]=g[h]|a>>e,g[h+1]=a<<8-e&255,h+=1,i=e),i===8&&(i=0,h+=1)}var c,d,e,f=new ArrayBuffer(Math.ceil(b/8)),g=new Uint8Array(f),h=0,i=8-(b%8||8);for(c=0;c<a.length;c+=1){j(a[c].value[0],a[c].length%8||8);for(d=1;d<a[c].value.length;d+=1)j(a[c].value[d])}return f}return{parse:function(a,b,e,f){var g,h={},i=0;return typeof a=="string"&&(a=bitratchet.hex({length:4*a.length}).unparse(a)),b=b||{},e=e||{},f&&e?(e[f]=h,g=e):g=h,c(function(c,e){var f,j;typeof e=="function"&&(e=e(b,g)),e&&(e.hasOwnProperty("parse")?e.length?(f=e.parse(d(a,i,e.length),b,g,c),i+=e.length):(j=e.parse(d(a,i,0),b,g,c),f=j.data,i+=j.length):f=e,f!==undefined&&(h[c]=f))}),{data:h,length:i}},unparse:function(a,b,d,f){var g,h=[],i,j,k,l,m=0,n={};b=b||{},d=d||{};for(i in a)a.hasOwnProperty(i)&&(n[i]=a[i]);return f&&d?(d[f]=n,g=d):g=n,c(function(a,c){typeof c=="function"&&(c=c(b,g));if(c&&c.hasOwnProperty("unparse")){if(!n.hasOwnProperty(a)){if(c.missing===undefined)throw'Data missing for field "'+a+'" and no default value given.';typeof c.missing=="function"?n[a]=c.missing(b,g):n[a]=c.missing}c.length?(j=c.unparse(n[a],b,g,a),l=c.length):(k=c.unparse(n[a],b,g,a),j=k.data,l=k.length),j===undefined?h.push({value:new Uint8Array(new ArrayBuffer(Math.ceil(l/8))),length:l}):h.push({value:new Uint8Array(j),length:l}),m+=l}}),{data:e(h,m),length:m}}}}),typeof bitratchet.number!="function"&&function(){function a(a){return a%8||8}function b(a){var b,c=1;for(b=a.length-1;b>=0;b-=1)a[b]=~a[b]&255,c&&(a[b]<255?(a[b]+=c,c=0):(a[b]=0,c=1));return a}function c(c,d,e){var f,g,h;g=0,e&&c[0]&Math.pow(2,a(d)-1)&&(b(c,d),h=!0),c[0]=c[0]&Math.pow(2,a(d))-1;for(f=0;f<c.length;f+=1)g+=c[c.length-f-1]*Math.pow(2,f*8);return h?-g:g}function d(c,d){var e,f,g=new ArrayBuffer(Math.ceil(d/8)),h=new Uint8Array(g);c<0&&(c=Math.abs(c),f=!0);for(e=0;e<h.length;e+=1)h[h.length-1-e]=c/Math.pow(2,e*8)&255;return f&&b(h,d),h[0]=h[0]&Math.pow(2,a(d))-1,g}function e(a,b){return b===undefined?a:Math.round(a*Math.pow(10,b))/Math.pow(10,b)}function f(a){return a.custom_scale||a.scale_range&&a.scale_range/Math.pow(2,a.length)||1}bitratchet.number=function(b){return{parse:function(a){var d;return a=(new Uint8Array(a)).subarray(0,Math.ceil(b.length/8)),d=new Uint8Array(new ArrayBuffer(a.length)),d.set(a),e(c(d,b.length,b.signed)*f(b),b.precision)},unparse:function(a){return d(Math.round(a/f(b)),b.length)},length:b.length,missing:b.missing}}}(),typeof bitratchet.string!="function"&&function(){bitratchet.string=function(b){function c(a){var b,c=[],d=new Uint8Array(a);for(b=0;b<d.length;b+=1)c[b]=String.fromCharCode(d[b]);return c.join("")}function d(a,b){var c,d=new ArrayBuffer(b),e=new Uint8Array(d);for(c=0;c<e.length;c+=1)e[c]=a.charCodeAt(c);return d}if(b.length&&b.length%8)throw"Invalid length, must be divisible by 8.";if(!b.length&&b.terminator===undefined&&!b.pascal)throw"String needs either a length, terminating character or to be a pascal string.";if(b.pascal&&(b.terminator!==undefined||b.length))throw"Pascal strings don't support the other options.";if(b.read_full_length&&(b.terminator===undefined||!b.length))throw"read_full_length option required both length and terminator options.";return{parse:function(a){var d,e,f=!1;e=c(a);if(b.pascal)return{data:e.substr(1,e.charCodeAt(0)),length:(e.charCodeAt(0)+1)*8};if(this.length)return b.terminator!==undefined&&(d=e.search(String.fromCharCode(b.terminator))),b.terminator!==undefined&&d>-1?e.substr(0,d):e.substr(0,b.length/8);d=e.search(String.fromCharCode(b.terminator));if(d===-1){if(!b.length)throw"Unterminated string, provide a length.";d=b.length/8}else d>b.length/8&&(d=b.length/8,f=!0);return{data:e.substr(0,d),length:b.read_full_length||f?b.length:(d+1)*8}},unparse:function(a){var c;return b.pascal?(a=String.fromCharCode(a.length)+a,{data:d(a,a.length),length:a.length*8}):(b.terminator!==undefined&&(!b.length||a.length*8<b.length)&&a.search(String.fromCharCode(b.terminator))===-1&&(a+=String.fromCharCode(b.terminator)),c=d(a,this.length/8||a.search(String.fromCharCode(b.terminator))+1||b.length/8),this.length?c:{data:c,length:c.byteLength*8})},length:function(){if(b.length&&(b.terminator===undefined||b.read_full_length))return b.length}(),missing:b.missing}}}(),typeof bitratchet.lookup!="function"&&(bitratchet.lookup=function(b){return{parse:function(a,c,d,e){var f=b.type.parse(a);if(b.table.hasOwnProperty(f))return b.table[f];throw"Value '"+f+"' not in lookup-table"+(e?" '"+e+"'.":".")},unparse:function(a,c,d,e){var f,g;for(f in b.table)if(b.table.hasOwnProperty(f)&&b.table[f]===a)return g=b.type.unparse(f),this.length=b.type.length,g;if(b.missing===undefined)throw"Value '"+a+"' not in lookup-table"+(e?" '"+e+"'.":".")},length:b.type.length,missing:b.missing}}),typeof bitratchet.flags!="function"&&(bitratchet.flags=function(b){function e(a){return a&&typeof a=="object"&&a.constructor===Array}function f(a){return Math.floor(a/8)}function g(a){return 7-a%8}function h(a,b){var c;for(c=0;c<a.length;c+=1)if(a[c]===b)return c;return-1}var c,d=b.length%8;return c=b.values.length===2&&!e(b.values[0])&&!e(b.values[1]),{parse:function(a){var e,h,i={};a=new Uint8Array(a);for(e=0;e<b.length;e+=1)b.flags[e]&&(h=a[f(e+d)]>>g(e+d)&1,i[b.flags[e]]=c?b.values[h]:b.values[e][h]);return i},unparse:function(a){var e,i,j=new ArrayBuffer(Math.ceil(b.length/8)),k=new Uint8Array(j);for(e=0;e<b.flags.length;e+=1)b.flags[e]&&(i=h(c?b.values:b.values[e],a[b.flags[e]])<<g(e+d),k[f(e+d)]=k[f(e+d)]|i);return j},length:b.length,missing:b.missing}}),typeof bitratchet.skip!="function"&&(bitratchet.skip=function(b){return{parse:function(){},unparse:function(){},length:b.length,missing:function(){}}}),typeof bitratchet.array!="function"&&(bitratchet.array=function(b){return{parse:function(a,c,d){var e,f,g=[],h={},i=typeof b.size=="function"?b.size(c,d):b.size;for(e=0;e<i;e+=1)h[e]=typeof b.type=="function"?b.type(c,d,e):b.type;f=bitratchet.record(h).parse(a);for(e=0;e<i;e+=1)g[e]=f.data[e];return this.length===undefined?{length:f.length,data:g}:g},unparse:function(a,c,d){var e,f,g={},h=typeof b.size=="function"?b.size(c,d):b.size,i={};for(f=0;f<h;f+=1)g[f]=typeof b.type=="function"?b.type(c,d,f):b.type,i[f]=a[f];return e=bitratchet.record(g).unparse(i),this.length===undefined?{length:e.length,data:e.data}:e.data},length:function(){if(typeof b.type!="function"&&b.type.length&&typeof b.size!="function")return b.size*b.type.length}()}}),typeof bitratchet.hex!="function"&&(bitratchet.hex=function(b){if(b.length%4!==0)throw"Invalid length, must be divisible by 4.";return{parse:function(a){var c,d="";a=new Uint8Array(a);if(b.length>a.length*8)throw"Too little data given to parse to hex.";for(c=0;c<a.length;c+=1)a[c]<16&&(d+="0"),d+=a[c].toString(16);return d.substr(d.length-b.length/4)},unparse:function(a){if(!a||typeof a!="string"||!/^[0-9a-fA-F]+$/.test(a))throw"Invalid hex '"+a+"', can't unparse.";var c,d=new ArrayBuffer(Math.ceil(b.length/8)),e=new Uint8Array(d);a.length%2&&(a="0"+a),a=a.match(/.{1,2}/g);for(c=0;c<e.length;c+=1)e[c]=parseInt(a[c],16);return b.length%8&&(e[0]=e[0]&15),d},length:b.length,missing:b.missing}})}(),typeof module!="undefined"&&(module.exports=bitratchet);